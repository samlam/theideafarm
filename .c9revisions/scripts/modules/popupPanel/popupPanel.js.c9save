{"ts":1360215792377,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"/*example\r\n    var p = new PopupPanel({\r\n        el: $('div#pp')\r\n    });\r\n    p.render(imgUrl, title, details, postId, 'S1');\r\n*/\r\n\r\ndefine([\r\n    'text!modules/popupPanel/popupPanel.html',\r\n    'css!modules/popupPanel/popupPanelS1.css', //desktop mode\r\n    'css!modules/popupPanel/popupPanelS2.css', //desktop wide mode\r\n    'css!modules/popupPanel/popupPanelS2.css',  //mobile mode\r\n    'css!syntaxhighlighter/css/shCore.css',\r\n//'css!syntaxhighlighter/css/shCoreDefault.css',\r\n    'css!syntaxhighlighter/css/shThemeDefault.css',\r\n    'css!wiky.css',\r\n    'js!wiky.js',\r\n//'js!syntaxhighlighter/js/shCore.js',\r\n//'js!syntaxhighlighter/js/shAutoloader.js',\r\n    'js!syntaxhighlighter/js/shBrushPlain.js',\r\n    'js!syntaxhighlighter/js/shBrushJScript.js',\r\n    'js!syntaxhighlighter/js/shBrushCss.js'\r\n    ],\r\n    function (html, cssS1, cssS2, cssS3) {\r\n        var PopupPanel = Backbone.View.extend({\r\n            el: $('div#pp'),\r\n            template: html,\r\n            css: cssS1,\r\n            imgOrientation: 0, //0 undefined, 1- portrait, 2- landscape\r\n            popupDetailsExpandEvent: popupDetailsExpandEvent,\r\n            hiddenCallback: null,\r\n            currentStyle: 'S1',\r\n            bind: function (selector, event, callback) {\r\n                var $doc = $(document);\r\n                $doc.on(event, function (e) {\r\n                    if (e.target === $(selector)[0]) {\r\n                        callback(e.target);\r\n                    }\r\n                });\r\n            },\r\n            /*\r\n            bind: function (selector, event, callback) {\r\n            var self = this;\r\n            $(self.el).find(selector).bind(event, callback);\r\n            }*/\r\n            initialize: function () {\r\n                var self = this;\r\n                $(document).keyup(function (e) {\r\n                    if (e.keyCode == 27) {\r\n                        self.hide();\r\n                    }\r\n                });\r\n                /*\r\n                SyntaxHighlighter.autoloader(\r\n                'js jscript javascript  /scripts/syntaxhighlighter/js/shBrushJScript.js',\r\n                'css                    /scripts/syntaxhighlighter/js/shBrushCss.js'\r\n                );*/\r\n            },\r\n            render: function (imgUrl, title, details, postId, style, callback) {\r\n                var self = this,\r\n                    t = null,\r\n                    tags = [],\r\n                    tData = {\r\n                        postId: postId,\r\n                        title: title,\r\n                        imgUrl: imgUrl,\r\n                        details: details\r\n                    };\r\n\r\n                t = _.template(self.template, tData);\r\n                $(this.el).html(t);\r\n                self.currentStyle = style;\r\n                //$('div#ppDetailsViewer div#inner').html(wiky.process(details));\r\n                self.centerPopup();\r\n                self.applyCss(self.currentStyle);\r\n                SyntaxHighlighter.highlight();\r\n                self.show();\r\n                if (callback) callback();\r\n            },\r\n            show: function () {\r\n                var b = $(\"#popupPanelBackdrop\");\r\n                b.css('display', 'block');\r\n                b.css('opacity', 1);\r\n                $('body').css('overflow', 'hidden');\r\n            },\r\n            hide: function () {\r\n                var b = $(\"#popupPanelBackdrop\");\r\n                b.css('opacity', 0);\r\n                setTimeout(function () {\r\n                    b.css('display', 'none');\r\n                }, 500);\r\n\r\n                $('body').css('overflow', 'scroll');\r\n                if (this.hiddenCallback) this.hiddenCallback();\r\n            },\r\n            populateTags: function (details) {\r\n                var self = this;\r\n                tags = self.findTags(details);\r\n                if (!tags || tags.length == 0) return;\r\n                var objs = []\r\n                tags.forEach(function (element, index, array) {\r\n                    var v = element.trim().substring(1);\r\n                    objs.push({\r\n                        label: v,\r\n                        value: v\r\n                    });\r\n                });\r\n                $('#ppTag').tagit();\r\n                $('#ppTag').tagit(\"fill\", objs);\r\n            },\r\n            getTagsFromDetails: function () {\r\n                var self = this;\r\n                var ppContentDetails = $(self.el).find('div#ppBody div.content div.details textarea[name=\"details\"]');\r\n                var buff = self.findTags(ppContentDetails.val());\r\n                if (!buff) return null;\r\n                var ret = []\r\n                buff.forEach(function (element, index, array) {\r\n                    ret.push(element.trim().substring(1));\r\n                })\r\n\r\n                return ret.join(','); //returns as a string, obj array doesn't work\r\n            },\r\n            centerPopup: function () { //imgSrc, title, details\r\n                ///request data for centering\r\n                var self = this;\r\n                var windowWidth = document.documentElement.clientWidth,\r\n                    windowHeight = document.documentElement.clientHeight,\r\n                    content = $(self.el);\r\n                var popupWidth = ((windowWidth - 100) < 740) ? windowWidth - 100 : 740; //$(\"#popupPanel\").width();\r\n                var ppPanel = content.find(\"#popupPanel\"),\r\n                    ppPanelBackdrop = content.find('#popupPanelBackdrop'),\r\n                    ppImg = content.find(\"img#ppImg\"),\r\n                    ppContent = content.find('div#ppBody div.content'),\r\n                    ppContentDetails = content.find('div#ppBody div.content div.details textarea[name=\"details\"]'),\r\n                    ppContentDetailsViewer = content.find('div#ppDetailsViewer'),\r\n                    ppBg = content.find('#ppBg'),\r\n                    ppPic = content.find('div#ppBody div.pic'),\r\n                    ppBody = content.find('div#ppBody'),\r\n                    inner = content.find('div#inner');\r\n\r\n                //inner.html(inner.text().replace(/(\\r\\n|\\n|\\r)/g, \"<br />\"));\r\n                var wikiContent = wiky.process(document.htmlEncode(ppContentDetails.val()));\r\n                inner.html(wikiContent);\r\n                ppPanelBackdrop.click(function (e) {\r\n                    if ($(e.target).is(\"#popupPanelBackdrop\")) {\r\n                        self.hide();\r\n                    }\r\n                });\r\n\r\n                ppPanel.width(popupWidth);\r\n\r\n                //HAVE TO GET THE NAME HERE\r\n                //$('div#popupBody h1').text();\r\n                ppContentDetailsViewer.bind('click', function (e) {\r\n                    switch (e.target.tagName) {\r\n                        case \"A\":\r\n                        case \"IMG\":\r\n                        case \"EMBED\":\r\n                            return;\r\n                    }\r\n                    ppContentDetailsViewer.hide();\r\n                    ppContentDetails.show();\r\n                    ppContentDetails.focus();\r\n                });\r\n                self.bind(ppContentDetails.selector, self.popupDetailsExpandEvent, function () {\r\n                    self.resizePopup(ppImg, null, ppContent, ppBg, ppPic, ppBody);\r\n                });\r\n                /*\r\n                ppContentDetails.bind(self.popupDetailsExpandEvent, function () {\r\n                    self.resizePopup(ppImg, null, ppContent, ppBg, ppPic, ppBody);\r\n                });*/\r\n\r\n                ppImg.load(function () {\r\n                    self.resizePopup(ppImg, null, ppContent, ppBg, ppPic, ppBody);\r\n                });\r\n                if ($(\"#ppImg\").attr(\"src\") == '') {\r\n                    $(\"#ppImg\").attr(\"src\", \"http://cdn-img.easyicon.cn/png/282/28286.gif\");\r\n                }\r\n\r\n                self.populateTags(ppContentDetails.val());\r\n\r\n                ppContentDetails.hide();\r\n                ppContentDetailsViewer.show();\r\n\r\n                //var p = $(document).scrollTop() + 20;\r\n                //centering\r\n                ppPanel.css({\r\n                    \"left\": windowWidth / 2 - popupWidth / 2\r\n                });\r\n\r\n            },\r\n            resizePopup: function (ppImg, ppControl, ppContent, ppBg, ppPic, ppBody) {\r\n                var pHeight = (ppImg.height() > ppContent.height()) ? ppImg.height() : ppContent.height();\r\n                ppBg.height(ppBody.height());\r\n                //ppPic.height(pHeight);\r\n                if (ppImg.width() < ppImg.height()) {\r\n                    if (ppImg.height() >= pHeight) {\r\n                        ppPic.css('border-bottom-left-radius', '9px');\r\n                        ppImg.css('border-bottom-left-radius', '9px');\r\n                    }\r\n                    else {\r\n                        ppPic.css('border-bottom-left-radius', '9px');\r\n                        ppImg.css('border-bottom-left-radius', '0px');\r\n                    }\r\n                }\r\n            },\r\n            applyCss: function (style) {\r\n                var self = this,\r\n                    cssRuleList = cssS1;\r\n                var c = $(self.el),\r\n                    cssSelector,\r\n                    cssName,\r\n                    cssValue;\r\n\r\n                switch (style) {\r\n                    case 'S1': //desktop mode\r\n                        cssRuleList = (self.imgOrientation == 1) ? cssS1 : cssS2;\r\n                        break;\r\n                    case 'S2':\r\n                        cssRuleList = cssS2;\r\n                        break;\r\n                    case 'S3': //mobile\r\n                        cssRuleList = cssS3;\r\n                        break;\r\n                    default:\r\n                        cssRuleList = cssS1;\r\n                }\r\n\r\n                for (var i = 0; i < cssRuleList.cssRules.length; i++) {\r\n                    cssSelector = cssRuleList.cssRules[i].selectorText;\r\n                    var items = cssRuleList.cssRules[i].style.cssText.split(';');\r\n                    for (var j = 0; j < items.length; j++) {\r\n                        var kv = items[j].split(':');\r\n                        cssName = kv[0];\r\n                        cssValue = kv[1];\r\n                        if (cssName.length < 1) continue;\r\n                        c.find(cssSelector).css(cssName.trim(), cssValue.trim());\r\n                    }\r\n                }\r\n            },\r\n            findTags: function (content) {\r\n                var words = content.match(/^@[\\w-]+| @[\\w-]+/gim);\r\n                return words;\r\n            }\r\n        });\r\n        return PopupPanel;\r\n    }\r\n);\r\n"]],"start1":0,"start2":0,"length1":0,"length2":10520}]],"length":10520}
